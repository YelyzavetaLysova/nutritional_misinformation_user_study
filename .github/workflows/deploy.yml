name: Deploy to Server

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.7.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
        
    - name: Add server to known hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H 10.1.1.140 >> ~/.ssh/known_hosts
        
    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=accept-new ubuntu@10.1.1.140 'bash -s' << 'EOT'
          # Stop the service
          sudo systemctl stop nutritional-survey || true
          
          # Create the project directory if it doesn't exist
          mkdir -p ~/nutritional_misinformation_user_study
          cd ~/nutritional_misinformation_user_study
          
          # Pull latest changes or clone if directory is empty
          if [ -d .git ]; then
            git pull
          else
            git clone https://github.com/YelyzavetaLysova/nutritional_misinformation_user_study.git .
          fi
          
          # Set up Python environment
          python3 -m venv venv || true
          source venv/bin/activate
          pip install -r requirements.txt
          
          # Create necessary directories
          mkdir -p data/responses logs
          chmod -R 755 data logs
          
          # Create systemd service file if it doesn't exist
          if [ ! -f /etc/systemd/system/nutritional-survey.service ]; then
            sudo bash -c 'cat > /etc/systemd/system/nutritional-survey.service << EOF
[Unit]
Description=Nutritional Misinformation Survey
After=network.target

[Service]
User=$(whoami)
Group=$(whoami)
WorkingDirectory=$(pwd)
ExecStart=$(pwd)/venv/bin/gunicorn -w 4 -k uvicorn.workers.UvicornWorker -b 127.0.0.1:8000 run:app
Restart=always

[Install]
WantedBy=multi-user.target
EOF'
          fi
          
          # Create nginx config if it doesn't exist
          if [ ! -f /etc/nginx/sites-available/nutritional-survey ]; then
            sudo bash -c 'cat > /etc/nginx/sites-available/nutritional-survey << EOF
server {
    listen 80;
    server_name 10.1.1.140;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF'
            
            # Enable the site
            sudo ln -sf /etc/nginx/sites-available/nutritional-survey /etc/nginx/sites-enabled/
            sudo rm -f /etc/nginx/sites-enabled/default
            sudo nginx -t && sudo systemctl restart nginx
          fi
          
          # Start the service
          sudo systemctl daemon-reload
          sudo systemctl enable nutritional-survey
          sudo systemctl start nutritional-survey
          
          # Check the status
          sudo systemctl status nutritional-survey
        EOT
